\documentclass{report}
\usepackage[utf8]{inputenc}
\usepackage{amsmath,amsthm,amsfonts,amssymb,amscd}
\usepackage[a4paper,hmargin=0.8in,bottom=1.3in]{geometry}
\usepackage{lastpage,enumerate,fancyhdr,mathrsfs,xcolor,graphicx,listings,hyperref,enumitem}
\newcommand{\protorow}[5]{#1 & #2 & #3 & #4 & #5\\ \hline}
\makeatletter
\def\maxwidth#1{\ifdim\Gin@nat@width>#1 #1\else\Gin@nat@width\fi}
\makeatother
\hbadness 100001
\newcommand{\mygraphic}[1]{
\begin{center}
    \includegraphics[width=\maxwidth{15cm}]{#1}
\end{center}
}
\author{Hardik Rajpal}
\title{Of packets and their journeys.}
\begin{document}
\maketitle
\tableofcontents
\chapter{Misc}
\section{Big Fat Protocol Table}
\begin{itemize}
\item Model Layer refers to the layer that the protocol is modelled to be a part of.
\end{itemize}
\begin{center}
\begin{tabular}{| p{1cm} | p{2cm} | p{2.5cm} | p{5cm} | p{4cm} | }
\hline
\protorow{Name}{Operates over}{Model Layer}{Function}{Remarks}
\protorow{ARP}{N/A}{Link}{Returns the MAC address corresponding to an IP address}{\hyperref[sec:arp]{Further discussion.}}
\protorow{DHCP}{UDP}{Application}{Used to obtain new IP address assignments for hosts.}{\hyperref[sec:dhcp]{Further discussion.}}
\protorow{ICMP}{IP}{Network}{Used by hosts and routers to communicate network level information}{\hyperref[sec:icmp]{Futher discussion.} \href{https://serverfault.com/questions/511965/why-is-icmp-categorized-as-a-layer-3-protocol}{Why is it on the network layer?}}
\protorow{UDP}{IP}{Transport}{Used for (process-) to-process delivery.}{\hyperref[sec:udp]{Read more.} Source process is unnecessary or deduced by application layer (ex. DHCP $\implies$ delivery to source is based on \hyperref[sec:dhcp]{link-layer broadcast and transaction id Xid})}
\protorow{}{}{}{}{}
\end{tabular}
\end{center}
\section{Addresses}
\begin{itemize}
\item Ethernet addresses are 48bits=6Bytes long.
\item IPv4 addresses are 32bits=4Bytes long.
\end{itemize}
\section{Data Units}
Reference: \href{https://www.baeldung.com/cs/networking-packet-fragment-frame-datagram-segment}{baeldung.} and \href{https://gateoverflow.in/139334/name-of-data-unit-at-different-layers}{Gateoverflow, I'm sorry, no offence.}
\begin{enumerate}
\item Packet (aka IP Datagram): data unit used at the network layer.
\begin{itemize}
    \item Comprises of the network layer header (src/dst IP addresses) and the payload (transport layer or otherwise).
    \item Basic unit of communication between a source and a destination in a network.
\end{itemize}
\item Fragment: Network layer unit. A packet can be split into multiple fragments, so as to ensure that each fragment is under the \textbf{Maximum Transmitted Unit} limit of the network.
\item Frame: Link layer unit, refers to one network layer fragment (or entire packet), encapsulated with link layer headers and trailers.
\begin{itemize}
    \item There exist two types of framing: fixed-length and variable-length.
    \item Fixed-length: the constant size eliminates the need for a delimiter.
    \item Variable-length: it's essential to define the start and end of the frame.
\end{itemize}
\item (UDP) Datagram: Unit used at the transport layer by UDP only. It refers to the application layer payload and the UDP header encapsulating it.
\item Segment: A segment is a transport layer unit. It refers to a piece of a packet and the TCP header encapsulating it.
\begin{itemize}
\item Segments increase the efficiency of network performance and improve security. (TODO: How?)
\end{itemize}
\item Message: Unit of data at application layer.
\end{enumerate}
\chapter{Link Layer}
\section{Address Resolution Protocol}
\label{sec:arp}
\begin{itemize}
\item Operates at link layer.
\item Used to find the MAC address m corresponding to an IP address a.
\item Broadcasts "who is a? tell srcIPAddress." message. Host with IP address a replies.
\begin{itemize}
\item Ex: \texttt{who is 10.11.63.71? tell 10.09.63.43.}
\end{itemize}
\item Each intermediate host maintains a cache of IP to MAC translations and updates its cache on parsing ARP replies and requests.
\item The requesting host saves the reply MAC in its cache.
\item Entries in said cache timeout periodically.
\item The packet format is:
\mygraphic{rsrc/arppacket.png}
\begin{itemize}
\item Hardware type specifies what link level technology we're using. For ex, it's set to 1 for ethernet.
\item Protocol Type refers to higher level protocol. It's 0x0800 for IP.
\item HLEN specifies length of the MAC address in bits.
\item PLEN specifies length of the protocol address in bits. It's 32 for IP address in bits.
\item Operation can be: request or reply.
\end{itemize}
\item The terms involved are:
\begin{itemize}
\item Originator: Host that generates ARP request.
\item Target: Host replying to the ARP request. It updates its cache with srcIP, srcMAC.
\end{itemize}
\item When a host has to forward a datagram that specifies a destination IP address (that is within the LAN),
\begin{enumerate}
    \item It first checks its ARP cache for a map from dstIP to MAC.
    \item If no entry is found, it broadcasts an ARP request.
    \item While the request and reply move through the LAN, intermediate hosts refresh their caches.
\end{enumerate}
\item Note: Intermediate hosts NEVER reply to ARP requests.
\end{itemize}
\subsection{Gratuitous ARP}
\begin{itemize}
\item Generated by a host to inform others of its IP and MAC address.
\item According to \href{https://networkengineering.stackexchange.com/questions/7713/how-does-gratuitous-arp-work}{this,} gratuitous ARPs are request packets and not reply packets.
\item Both IPdst and IPsrc are set to IP host, and src MAC is set to host MAC.
\item dst MAC is the broadcast address: \texttt{ff:ff:ff:ff:ff:ff}
\item No reply is expected.
\item Gratuitous ARP is used to:
\begin{enumerate}
\item Inform hosts of changes to my IP or MAC address.
\item Inform hosts that a host is now available.
\item Help rectify ARP entries.
\item Report IP address conflicts (duplicate IP addresses).
\item Inform learning bridges of the new location of the host, or the location of a new host.
\end{enumerate}
\item Note that since ARP is a stateless protocol, even replies that were never requested are parsed and processed and thus, can function as gratuitous ARPs.
\end{itemize}


\chapter{Network Layer}
\section{Obtaining IP Addresses}
\begin{itemize}
\item Organizations get the address blocks from ISPs, from whom they purchase internet routers. Ex: Reliance, Tata, Sprint, AT\&T.
\item ISPs in turn get address blocks from Regional Internet Registries (RIR) which are controlled by Internet Corporation for Assigned Names and Numbers (ICANN).
\item There are five RIRs:
\mygraphic{rsrc/rirs.png}
\item ISPs follow CIDR (covered before maybe) to assign blocks to organizations based on their size, and splits up blocks between organizations using different bits after the block's identifying bits.
\item ISP routers advertise the block address that they've been given by an RIR to other routers for receiving all those packets.
\item They don't advertise individual organize prefixes, but aggregate them all into the largest possible block.
\item Given that the organization has an IP prefix, each host needs a unique IP address (hence a suffix).
\item The address needs to be unique and location (subnet) dependent.
\item Additionally, it needs to be reconfigurable, unlike ethernet addresses which are fixed by the manufacturer. (Though even those can be modified in some OSes, like Linux).
\item Before any communication, the host needs:
\begin{enumerate}
    \item an IP address
    \item a mask that specifies what the network portion corresponds to
    \item the default router's IP address.
    \item the DNS server's IP address.
\end{enumerate} 
\item Manual configuration is one option.
\item Remote configuration is difficult and error prone.
\item Enter DHCP:
\end{itemize}
\section{DHCP}
\label{sec:dhcp}
\begin{itemize}
\item Operates at application layer, above UDP.
\item Used to obtain a new IP address assignment on joining a network or booting.
\item DHCP server maintains a pool of available IP address which it leases out on requests.
\item Leases expire periodically unless the hosts renew them.
\item It's advantages include:
\begin{itemize}
    \item Easy of configuration, as it's automated.
    \item Reuse of IP addresses, in the case where the total number of hosts is large but the number of hosts live at any time is very small.
    \item Support for portability of hosts across the network, across different subnets.
\end{itemize}
\item The packet format is:
\mygraphic{rsrc/dhcppacket.png}
\begin{itemize}
\item Operation specifies whether it's a request or reply.
\item Htype: hardware type: ethernet etc.
\item Hlen: specifies length of hardware addresses. It's 6 (Bytes) (48 bits) for ethernet.
\item Hops: indicates number of relays traversed. It's set to zero by the host.
\item Xid: transaction ID to match requests and replies. All messages corresponding to one DHCP transaction have the same Xid.
\item Secs: time elapsed since the client started the communication. A larger value means the server gives it more priority in the queue.
\item Flags: only 1 of 16 bits is used, corresponding to the broadcast flag: whether or not the server broadcasts its replies.
\begin{itemize}
\item It's set to 1 when the host broadcasts the discover message, so the server broadcasts its replies as the client doesn't have an IP address yet.
\item It's set to 0 when the host is renewing the lease, as it has an IP address that the server can send its replies on.
\end{itemize}  
\item Ciaddr: specifies the current IP address (if a previous assignment exists).
\item Yiaddr: (Your IP addr) the IP address that the server offers the client.
\item Siaddr: (Server IP addr) specified only if the client has to contact some other server as a part of the operation.
\begin{itemize}
\item Additionally, the client uses this in the request message to inform all DHCP servers which may have sent it a request of the server whose offer it has chosen to proceed with.
\item As the messages are broadcast, those rejected DHCP servers note this request message and terminate the transaction.
\end{itemize}
\item Giaddr: IP address of Relay agent if any.
\item Chaddr: Holds the hardware address corresponding to the client.
\item Sname: hostname of the server if it has one.
\item File: boot file if the server wants to specify one, it's typically not used.
\item Options: The client mentions the offered IP address here in the DHCP request packet. The client can also request additional information here, and the server can respond with \hyperref[addinfo]{additional information.}
\end{itemize}
\item Note that the same packet format is used by the client and the server.
\item DHCP has its origins in BOOTP which was used earlier in booting of machines where configuration files were sent over the network.
\end{itemize}
\subsection{Operation}
\begin{enumerate}
\item Host broadcasts a DHCP discover message, with the broadcast (dstIP=\texttt{255.255.255.255}) restricted to the physical network.
\begin{itemize}
    \item Note that all IP-level broadcasts are link-level broadcasts. Routers don't allow letting such messages out into the internet.
    \item All messages in this exchange have their dst IP address set to broadcast.
    \item This helps in the case of multiple DHCP servers being around; so that all servers receive the request message meant for a chosen offer, to know they have to terminate the connection.
    \item This allows the rejected servers to recycle the available IP addresses faster.
    \item The client sets its src IP address to \texttt{0.0.0.0} if it's requesting an IP address for the first time.
    \item In some cases of field values in the discover packets, unicast mayb be used. See this \href{https://superuser.com/questions/1536810/why-are-dhcp-messages-broadcast}{\textbf{if necessary.}}
    \item Otherwise, it uses its assigned IP address.
    \item The server as expected puts its IP address in the src IP address field.
\end{itemize}
\item DHCP server responds with DHCP offer message, while other hosts ignore the discover message.
\begin{itemize}
    \item The offered IP address is derived from the subnet IP address, and possibly the hosts' MAC address.
\end{itemize}
\item Host receives the offer and requests the offered IP address: DHCP request message.
\item DHCP server confirms the assignment: DHCP ack. The server also informs the client of the expiration time.
\end{enumerate}
\begin{itemize}
\item If the host requests for it, the DHCP server also passes:
\label{addinfo}
\begin{enumerate}
    \item the subnet mask
    \item default router's IP address
    \item domain name
    \item DNS server info
\end{enumerate}
\item One DHCP server can be used over multiple subnets, if DHCP Relays are installed in each subnet that forward messages to (and from) DHCP server via a unicast link.
\item Routers can act as DHCP relays.
\end{itemize}
\subsection{Router Configuration}
\begin{itemize}
\item Sysads manually configure the interface addresses on a router using network management tools.
\end{itemize}

\section{ICMP}
\label{sec:icmp}
\begin{itemize}
\item Stands for Internet Control Message Protocol.
\item Used by hosts and routers to communicate network-level information.
\item Operates on top of the Internet Protocol. (IP).
\end{itemize}
\chapter{Transport Layer}
\begin{itemize}
\section{Introduction}
\item Provides logical communication between two processes.
\begin{itemize}
    \item The devices running the processes are identified by their IP addresses.
    \item On each device, the process (application) involved in a connection is identified by a port.
\end{itemize}
\item Helps in multiplex, demultiplexing of packets for delivery to the right processes.
\item Aka end-to-end protocols.
\item Unit of data at transport layer is a segment. 
\end{itemize}
\subsection{Sockets}
\begin{itemize}
\item Sockets function as the interface between processes and the transport layer.
\item On a device (fixed IP address), a socket is identified by a port number.
\item There are two types of sockets that provide two corresponding types of (de)multiplexing.
\begin{enumerate}
\item Connectionless:
\begin{itemize}
    \item Used with UDP sockets.
    \item A socket on a machine (fixed IP address) is identified by a port number.
    \item Thus, once on the network, the socket is identified by a 2-tuple: (dst IP address, dst Port Number).
    \item Packets with the tuple are directed to the same socket (thus, process),
    regardless of the source IP address and port.
    \item It is the process' job to segregate the data from different clients.
\end{itemize}
\item Connection-oriented:
\begin{itemize}
    \item Used with TCP sockets.
    \item A socket on a machine (fixed dst IP address) is identified by src IP, src Port and dst Port.
    \item Thus, once on the network, the socket is identified  by a 4-tuple: (dst IP, dst Port, src IP, src Port).
    \item The server creates a new socket for each client that connects to it.
    \begin{itemize}
        \item In the program, the socket is identified by a file descriptor or a reference to some object wrapping around it.
        \item In the kernel, the fd is associated with the 4-tuple mentioned earlier.
        \item When a packet arrives with the four tuple, the kernel looks up the tuple's corresponding socket in a table, and sends the payload to that socket.
        \item The program access this by the read functions in the object wrapping around the socket's fd.
        \item Note: I am not sure how the lookup is done as this is a transport layer functionality which requires access to the network layer header (src IP). 
    \end{itemize}
\end{itemize}
\end{enumerate}
\end{itemize}
\subsection{Port Numbers}
\begin{itemize}
\item Ports are a logical construct, an abstraction, a figment of the programmers' inter-subjective imagination.
\item Physical ports refer to ports on a switch, not these ports.
\item 16bit numbers (0 to $2^16$ - 1) to identify processes using the network on a machine.
\item One process can listen to multiple ports, but one port can only be used by one process.
\item The point of the port abstraction is to allow for multiple processes to share the network without conflicts.
\item Some OS provide extensions to the above, allowing for port reuse. \href{https://stackoverflow.com/questions/1694144/can-two-applications-listen-to-the-same-port}{See this.}
\item Note that one computer may have two (active) IP addresses, by having two network cards, and two processes may use
    the ports with the same number on each IP address.
\end{itemize}
\section{Transmission Control Protocol}
\label{sec:tcp}
\begin{itemize}
\item Connection-oriented byte stream protocol.
\item Provides:
\begin{itemize}
    \item (De)Multiplexing.
    \item Reliable process to process data transfer.
    \item Full duplex connection.
    \item Flow control: receiver has control over sending rate.
    \item Congestion control: stops sender from overwhelming routers and network while using these resources sufficiently well.
\end{itemize}
\item Key idea: sliding window protocol.
\item Key challenges that TCP addresses:
\begin{enumerate}
\item Connection management: explicit connection establishment between two processes and tear-down.
\item Round Trip Time: Adaptive timeout mechanism to correspond to varying congestion rates and route availability.
\item Reordering: Arbitrary delays for each packet implies they need to be reordered at the destination.
\item Flow Control: Mechanism to ensure destination host isn't overwhelmed with the data transfer rate.
\item Congestion Control: Mechanism to ensure network (possibly changing) isn't overwhelmed with the data transfer rate.
\end{enumerate}
\item Segment format:
\mygraphic{rsrc/tcppacket.png}
\begin{itemize}
\item Without options, the header length is 20 B.

\end{itemize}
\end{itemize}
\section{User Datagram Protocol}
\label{sec:udp}
\begin{itemize}
\item Provides (de)multiplexing over best effort network layer service.
\item UDP segments can be lost, duplicated, delivered out of order.
\item Connectionless $\implies$ no handshaking phase between client and server.
\item Packet delivery to socket identified by (dst IP, dst Port)
\item Each DHCP segment is handled independently of the other.
\item Pros:
\begin{itemize}
    \item Not having a handshake phase, it has zero connection establishment overhead.
    \item Small segment header: less data overhead per packet.
    \item Server can support multiple clients due to the simplicity of the protocol.
    \item ? No congestion control: rate is independent of congestion in the network.
    \item No retransmission delay: useful for realtime applications like VoIP, games.
\end{itemize}
\item Cons:
\begin{itemize}
    \item No delivery guarrantees $\implies$ applications have to implement these capabilities on their own.
\end{itemize}
\item Protocols using UDP:
\begin{itemize}
    \item DHCP
    \item RIP
    \item DNS
    \item SNMP
\end{itemize}
\item UDP datagram format:
\mygraphic{rsrc/udppacket.png}
\begin{itemize}
\item Length refers to the total length of the segment in bytes = 8B header + app data.
\item Checksum is calculated over UDP header, app data and pseudo header from IP header.
\begin{itemize}
    \item Pseudo header includes the protocol version number, source and destination IP addresses.
    \item Checksum on pseudo header verifies correct delivery.
    \item Checksum is optional in IPv4 but compulsory in IPv6 as it doesn't have a checksum in its header.
\end{itemize}
\end{itemize}
\end{itemize}

\end{document}